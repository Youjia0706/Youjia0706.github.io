---
layout: post
title: 惡意程式分析
description: 惡意程式分析筆記
date: 2024-04-09 19:00:00
categories: 筆記
tags: 筆記
published: true
---

## 常見惡意程式

| 惡意程式類型                            | 說明                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| --------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 勒索軟體(Ransomware)                    | 主要是加密系統裡面的資料，並且向受害者索取費用。通常它們會使用 RSA 1024 來加密，在有限的時間內是無法破解此密碼演算法。                                                                                                                                                                                                                                                                                                                                                                                           |
| 病毒(Virus)                             | 病毒程式是常見的惡意程式，主要它會將自己的 payload 複製到宿主程式(例如常用的 office 軟體、Edge 瀏覽器、zoom 遠端通訊軟體)，透過宿主程式來繼續破壞系統比較難被察覺。每當宿主程式被運行，都會將病毒的 payload 繼續傳播給其他未感染的軟體，因此病毒在系統上很難被消除。                                                                                                                                                                                                                                             |
| Rootkit                                 | 主要目的是為了駭客能再獲取 root 最高權限的工具，由於為了可以永久的潛藏在受害者的系統，它會用一些手段來規避偵測以及隱藏檔案或目錄。Rootkit 又可分為 Usermode 和 Kernelmode，Usermode 主要會透過注入程式或 Library 的方式來獲取較高的系統權限提供給駭客；Kernelmode 主要是可以讀取 Kernel 全部的記憶體範圍，因此侵害系統的程度非常高，它可以任意的讀取、寫入 Kernel 的記憶體，並且攔截(Hooking)各種系統呼叫(System call)進而達成防護或攻擊的行為，例如:隱藏檔案、隱藏 TCP 或 UDP 連線、防止被關閉程式、Keylogger。 |
| Trojan                                  | Trojan 在網路上是非常常見和普遍的惡意程式，因為它都是透過偽裝正常應用軟體來讓受害者下載並執行，進而攻擊受害者的系統。由於 Trojan 程式被受害者下載時，基本上是沒有任何攻擊行為，因此防毒軟體或防護系統是不會偵測到此惡意程式，然而 Trojan 執行後它會連線到駭客的中繼站伺服器，抓取帶有攻擊性的惡意程式，例如 C&C 連線、Keylogger、竊取系統密碼(sam file)檔案或各種隱私資訊。                                                                                                                                      |
| Backdoor                                | Backdoor 主要是建立未授權的連線，在駭客成功攻擊受害者的系統並且為了讓後續能繼續存取這台伺服器，他都會從中繼站抓取 Backdoor 程式來運行到受害者的系統，因此就可以不須連線的驗證的存取此系統了。目前大部分駭客所使用的 Backdoor 都是屬於 Reverse 連線，他會在受害者端持續向駭客中繼站發出連線請求，只要駭客發送指令，就能操作受害者的系統，這種連線方式能規避防火牆或 NET 網路。                                                                                                                                    |
| Keylogger                               | Keylogger 是屬於高風險的惡意程式，他可以側錄受害者的鍵盤獲取各種資訊，通過這種手段是可以盜取信用卡、銀行帳密等等各種隱私資訊。Keylogger 在使用者輸入鍵盤時，進而獲取程式的名稱和標題(可以確認瀏覽器連到的網站)來知道他是存取哪個銀行或網購平台。由於有些銀行網站為了規避 Keylogger 程式，會透過螢幕鍵盤防止被側入鍵盤按鍵，因此進階的 Keylogger 是會側入螢幕來解決此問題。                                                                                                                                       |
| DNS tunnel                              | DNS tunnel 是利用 DNS 協定來通訊，這種連線方式可以規避各種防火牆、IPS/IDS 機制，是非常熱門的手段之一。現今 DNS tunnel 也是很常見的手法，我們可以看出他會將通訊內容放置在 sub-domain，因此完整 domain 相較起來都會比一般的 domain 還來得長。由於通訊隱匿性非常高，因此 Cobalt Strike(駭客工具)上的惡意程式也有 DNS tunnel 的功能，算是未來在惡意程式上會經常看到的方式。                                                                                                                                          |
| Advanced persistent threat (APT) Attack | Advanced persistent threat (APT) 攻擊是有針對性和持續性的攻擊，通常是商業或是否種政治動機來發動的攻擊，這種行為侵略性非常高。它的攻擊管道，通常是透過郵件社交工程搭配現有的 CVE 漏洞或 Zero day 漏洞進行滲透政府或公司電腦，並且竊取相關機密資料回傳到 C2 Server。                                                                                                                                                                                                                                               |

## Endian

最常見的位元組順序有兩種，分別是 Big-Endian 與 Little-Endian，Big-Endian 是指資料放進記憶體中的時候，最高位的位元組會放在最低的記憶體位址上，而 Little-Endian 則是剛好相反，它會把最低位的位元組放在最低的記憶體位址上。

![image](https://hackmd.io/_uploads/BylRmJCQ0.png)

---

![image](https://hackmd.io/_uploads/rJiCQJR7A.png)

## 惡意程式分析目的

- 獲取 IOC 情資
  IP、PORT 、Domain name
- 行為模式
  C&C 、Keylogger、Spam、DNS tunnel
- 攻擊目的
  已知 APT 組織或是其他未知行動
- 確認竊取哪些隱私資料
  系統使用者帳密的 Hash(SAM、SYSTEM)
- 確認防護機制
  Packer、Obfuscate 、 Encryption
- 確認資料加解密邏輯
  RSA 、AES、RC4
- 撰寫 Yara Rule 特徵
  透過撰寫腳本的方式偵測惡意程式，可用於部屬在偵測設備之上

## IoC(Indicator of Compromise )入侵指標

入侵指標 (IoC) 是攻擊者或惡意軟體留下的證據，可用來識別資安事件，此資料可能包括攻擊的詳細資料，例如所使用的惡意程式碼類型、涉及的 IP 位址、惡意中繼站(C2 Server)以及其他技術詳細資料。

IoC 可以透過幾種方法獲得，包括：

1. 觀察：監視系統或裝置中的異常活動或行為
2. 分析：確定可疑活動的特徵並分析其影響
3. 簽章：識別已知的惡意軟體簽章

惡意程式為了隨系統⾃動啟動，會在 Registry 建⽴啟動項。(開機就會⾃動出現，準備做事，這就是啟動項，使⽤者⼀登入，該程式就⾃動執⾏)
登錄檔(Registry)：Windows 作業系統內建的一個樹狀、有階層式，存放所有電腦相關設定資訊的資料庫。
![image](https://hackmd.io/_uploads/rym9dStxA.png)
分析惡意程式時，可以先查看 Windows 的 Event log。(Linux syslog)

1. 應用程式日誌：這些日誌記錄了與應用程式相關的事件，如應用程式錯誤、警告等。可以在事件檢視器中的「應用程式和服務日誌」下找到。

2. 安全日誌：安全日誌記錄了與系統安全性相關的事件，如登錄嘗試、安全策略更改等。可以在事件檢視器的「Windows 日誌」 -> 「安全」下找到。

3. 系統日誌：系統日誌記錄了與系統運行和硬體相關的事件，如系統啟動、關機、驅動程序錯誤等。可以在事件檢視器的「Windows 日誌」 -> 「系統」下找到。

4. 網路日誌：如果系統配置了網路日誌記錄，可能還可以查看與網路通訊相關的日誌。這些日誌通常由防火牆或安全軟體生成。

## 常見 IoC 類型

- 基於網路的 IoC（例如惡意 IP 位址、網域或 URL）還可以包括網路流量模式、異常連接埠活動、與已知惡意主機的網路連線或資料外流模式。
- 基於主機的 IoC 與工作站或伺服器上的活動相關。檔案名稱或雜湊、登錄機碼或在主機上執行的可疑處理序都是基於主機的 IoC 的範例。
- 基於檔案的 IoC 包括惡意程式碼或指令碼等惡意檔案。
- 行為 IoC 涵蓋多種類型的可疑行為，包括奇怪的使用者行為、登入模式、網路流量模式和驗證嘗試。
- 中繼資料 IoC 與檔案或文件關聯的中繼資料有關，例如作者、建立日期或版本詳細資訊。

## 靜態分析與動態分析

靜態逆向分析:主要使用的工具為 IDA，透過 IDA 的分析，我們能知道惡意程式的運行概要，以及部分資訊，例如 IP、PORT 或 Domain name。
動態逆向分析:顧名思義就是讓惡意程式運行起來，並從一些分析工具(x64dbg 、Process Monitor、TCPView、Autoruns、ProcessExplorer)來找出行為模式，透過動態逆向分析可以確認其惡意程式的行為。
在分析惡意程式會透過進階動態分析的工具來確認是否運作哪些行，因為靜態分析只能了解惡意程式整體的概況，並不能確認程式的運作，所以我們會需要使用動態分析的工具來協助我們查看惡意程式。
![image](https://hackmd.io/_uploads/SJAYhSYlC.png)

## 惡意程式常用 Win32 API

### Win32 API for Network

惡意程式要傳送資料或通訊給中繼站，會使用這些 API

| Win32 API           | 功能說明                                            |
| ------------------- | --------------------------------------------------- |
| HttpOpenRequestA    | 開啟 HTTP 的請求                                    |
| InternetConnectA    | 連線到遠端 Session                                  |
| InternetOpenUrlA    | 透過 URL 來開啟連線                                 |
| HttpSendRequestA    | 傳送 HTTP 封包給遠端伺服器                          |
| InternetReadFile    | 藉由 HTML stream 接收遠端的資料(可能是任何檔案)     |
| InternetWriteFile   | 藉由 HTML stream 傳送資料到遠端(可能是任何檔案)     |
| InternetCloseHandle | 關閉連線 Session                                    |
| WSAConnect          | Windows 平台的建立網路連線                          |
| WSASend             | Windows 平台的傳送資料到遠端                        |
| WSARecv             | Windows 平台的接收遠端資料                          |
| connect             | 建立網路連線                                        |
| send                | 傳送資料到遠端                                      |
| recv                | 接收遠端資料                                        |
| DnsQuery_A          | Window 平台獲取 DNS 的 IP 資訊(只限於 Windows)      |
| gethostbyname       | 獲取 DNS 的 IP 資訊                                 |
| getaddrinfo         | 獲取 DNS 的 IP 詳細資訊((包含 IPv4 或 IPv6 的資訊)) |

gethostbyname 和 getaddrinfo 可用於 Window 和 Linux 平台

### Win32 API for Process and I/O

| Win32 API                | 功能說明                                          |
| ------------------------ | ------------------------------------------------- |
| CreateProcessA           | 創建新的 Process                                  |
| CreatePipe               | 建立 Pipe，為了讀取或寫入資料導向到其他 I/O       |
| CreateToolhelp32Snapshot | 擷取系統中目前正在執行的程式                      |
| TerminateProcess         | 無條件結束程式                                    |
| SetWindowsHookExA        | Hook Win API (監聽鍵盤、滑鼠、Process 等各種事件) |
| GetAsyncKeyboardState    | 獲取非同步鍵盤狀態資訊                            |
| GetKeyState              | 獲取鍵盤狀態資訊                                  |
| CreateFile               | 開啟檔案                                          |
| WriteFile                | 寫入檔案                                          |
| ReadFile                 | 讀取檔案                                          |

### Win32 API for Registry

| Win32 API        | 功能說明           |
| ---------------- | ------------------ |
| RegCreateKeyExA  | 創建 Registry      |
| RegOpenKeyExA    | 開啟 Registry      |
| RegSetKeyValueA  | 寫入 Registry 數值 |
| RegQueryValueExA | 查詢 Registry 數值 |

## 靜態函式庫與動態函式庫優缺點

- Static Link
  將程式用到的函式庫函數一起包到程式中。
- Dynamic Linl
  將程式哪邊有用到函式庫函數記錄下來，並且在執行階段才把外部函式庫加載進記憶體，並進行連結。(載入時會有順序，而惡意 DLL 放在較前的位置)

|      | 靜態函式庫                          | 動態函式庫                                          |
| ---- | ----------------------------------- | --------------------------------------------------- |
| 優點 | 不需要考慮執行環境的相依性問題      | 使用空間小(檔案和記憶體)、更換 library 不用重 build |
| 缺點 | 執行檔極大、更換 library 需重 build | 在異地執行可能會因為相依性無法執行                  |

## 惡意程式分析工具

### Exeinfo PE

Exeinfo PE 是一款觀察 PE(Portable Executable)執行檔資訊的工具，不僅可以觀察 PE 詳細的資訊，也可以檢測它的防護機制，例如加殼(Packer)、程式碼混淆(Code Obfuscation)等等。

- 觀察執行檔運行環境(x64 or x86)。
- 分析執行檔格式資訊。
- 判斷是否有加殼(Packer)。

### Process Explorer

Process Explorer 是一款可以檢視 Windows 系統上所運行的 Process，不僅能觀察 Process 的狀態，還是可檢查程式是否為可疑程式，我們可以透過 Verify Image Signatures 來判斷程式是否有無簽章，如果沒有，我們可以視為可疑程式，並進一步分析它。

- 觀察系統是否有執行可疑程式。
- 藉由程式的簽章來確認程式是否有疑慮。

### TCPView

TCPView 是一款觀察每個 Process 網路連線的狀態，包括本地連線位址、本地連線 Port、遠端連線位址、遠端連線 Port 等等，非常容易的檢視連線狀態，優於傳統的指令(netstat -an)查看。

### Autoruns

Autoruns 是一款分析開機自動執行的工具，開機自動執行的意思是，每次開機時，都會自己運行在背景程序，因此惡意程式要確保每次重啟系統時，都要能穩定的運行惡意程式，所以我們可以透過 Autoruns 的 Logon 欄位，查看是否有可疑程式。

### Process Monitor

Process Monitor 是一款動態分析的工具，它會監控系統上所有 Process 的行為，並且列出每個事件的相關參數，我們可以藉由這些事件來了解惡意程式的行為，其中事件包含程式調用 API 狀況、I/O(檔案、Registory)讀取、寫入和 Create Process 等等。

## 加殼 Packer

許多惡意程式會透過加殼(Packer)的方式來避免被反編譯，因此如果想要靜態分析(動態分析不一定要解殼(Unpacker)，就需要將它解殼(Unpacker)才能完整地看到程式碼。(著名的加殼器:UPX)
解殼(Unpacker)是依賴它們有多少 Anti-Debugger 的技術，越多則越難，因為需要花大量的時間去測試它是哪種的 Anti-Debugger，不然每次 Debugger 工具去附加(Attach)程式，都會崩潰掉，很難找出真正原因。

### 壓縮殼(Compression Packer)

主要目的是讓程式壓縮成比較小一點，用來防止程式被靜態分析，因為它會修改 EntryPoint 和壓縮 IAT(Import Address Table)、rdate(Read-only)的 Section，讓分析者很難找到程式真正的入口點位址，當下也看不到相關的字串，這樣在靜態分析下是毫無任何進展，因此需要脫殼(Unpacker)才能繼續靜態分析。

## 參考資料

https://www.cloudflare.com/zh-tw/learning/security/what-are-indicators-of-compromise/
https://www.cloudflare.com/zh-tw/learning/ddos/glossary/malware/
https://tech-blog.cymetrics.io/posts/crystal/reverse-01/#fnref5
https://mks.tw/2968/%E8%B3%87%E8%A8%8A%E5%AE%89%E5%85%A8-%E5%BE%9E%E6%AF%AB%E7%84%A1%E5%9F%BA%E7%A4%8E%E9%96%8B%E5%A7%8B-pwn-%E6%A6%82%E5%BF%B5
https://ithelp.ithome.com.tw/articles/
https://speakerdeck.com/ljptw
https://xtutlab.medium.com/%E5%A3%93%E7%B8%AE%E6%AE%BC-compression-packer-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90-f5bff3a55970
https://www.cynet.com/advanced-threat-protection/what-is-cyber-threat-intelligence-cti/
https://0xrick.github.io/win-internals/pe2/
